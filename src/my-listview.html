
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../src/theme.html">

 
<dom-module id="my-listview">
  <template strip-whitespace>
    <style is="custom-style">
      :host {
        display: block;
          --paper-dropdown-menu-input: {
              color: yellow;
              font-style: italic;
              font-family: hind serif;
              text-transform: uppercase;
              border-bottom: none;
           };

            --paper-dropdown-menu: {
                    width: 20%;
             };
       
      }
  
      paper-dropdown-menu {
                 --paper-input-container-focus-color: green;
           }

            
     
      [icon="add"]{
        display: block;
        position: absolute;
        bottom: 20px;
      }
      
      paper-fab {
        position: absolute;
        bottom: 20px;
        right: 20px;
      }

      [icon="create"] {
        margin-left: auto; 
        color: red;
       }
      .task{
        width: 95%;
        margin: 0 auto;
      }

      #taskNameDialogBox > .buttons {
        display: flex;
        justify-content: space-between;
        color: var(--button-color);
        font-weight: 800;
      }
      #item span {
        /*align-self: flex-end;*/
        margin-left: 20%
      }

      paper-dialog paper-input {
       
        color: tomato;
      }
      
     
      /*paper-dropdown-menu {
        @apply(--paper-dropdown-menu-input);
      }*/
    </style>
    <!-- structure of listview -->
       <div class="task">
       <template is="dom-repeat" items="[[taskList]]" index-as="index">
         <paper-item id=item>
            <paper-dropdown-menu label="status" on-iron-select="updateTaskStatus">
            <paper-listbox class="dropdown-content" attr-for-selected="status" selected="{{item.status}}">
              <paper-item status="completed">completed</paper-item>
              <paper-item status="not started">not started</paper-item>
              <paper-item status="inprogress">inprogress</paper-item>              
            </paper-listbox>
         </paper-dropdown-menu>
         <span>[[item.name]]</span> 
           <paper-icon-button icon="create" on-tap="_editTask"></paper-icon-button>  
           <paper-icon-button icon="delete" on-tap="deleteTask"></paper-icon-button>
         </paper-item>
       </template>
       </div>
       <paper-fab icon="add" on-tap="_showAddTaskDialogBox"></paper-fab>
       <paper-dialog id="taskNameDialogBox" modal>
            <h3>Task Name Dialog Box</h3>
            <paper-input id="pi" label="Enter Task Name" autofocus required auto-validate error-message="task name cannot be empty!"
             value="{{taskName}}"></paper-input>
           <div class="buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button dialog-confirm autofocus on-tap="addTask">Confirm</paper-button>
             <paper-button  autofocus on-tap="_clearTaskName">Clear</paper-button>
          </div>
       </paper-dialog>
  </template>
  <script>
    Polymer({
      is: "my-listview",
      properties: {
          taskList: {
            type: Array,
            value: function() {
                    return [
                            
                           ]
                  }
          },

          listName: {
            type: String,
            value: "shopping"
          },
          taskName: {
            type: String
          }
      },
        ready: function() {
          
            this._updateListView();
        },
        updateTaskStatus: function(evt) {
          var selectedItem = evt.model.item;
          console.dir(selectedItem);
          console.log(selectedItem.status)
          localStorage.setItem(selectedItem.name, JSON.stringify({
               listName: selectedItem.listName,
               name: selectedItem.name,
               status: selectedItem.status
          }));

        },

        //  when user clicks on add button
        addTask: function() {
             console.dir(this);
             var taskNameIsValid = false;
             this._validateTaskNameInput(taskNameIsValid);
             if (taskNameIsValid) {
                localStorage.setItem(this.taskName, JSON.stringify({
                          listName: this.listName,
                          name: this.taskName,
                          status: "not started"
                      }));
                this.taskName = "";
                       
              this._updateListView();
             }
              
        },
        
        _clearTaskName: function() {
              var paperInputElem = Polymer.dom(this.$.taskNameDialogBox).querySelector("#pi");
              paperInputElem.value = "";
        },

        _editTask: function(evt) {
              // try to access paper icom button
              //console.dir(Polymer.dom(evt.target).parentNode);
              var taskName = evt.model.item.name;
             // var editTaskDialogBox = Polymer.dom(this.$.taskNameDialogBox); // why won't it work'
              var editTaskDialogBox = Polymer.dom(this.root).querySelector("#taskNameDialogBox");              
              editTaskDialogBox.querySelector("h3").innerText = "Edit Task Name";
              var paperInputElem = Polymer.dom(this.$.taskNameDialogBox).querySelector("#pi");
              paperInputElem.value = taskName;
              editTaskDialogBox.open();
        },
        _validateTaskNameInput: function(taskNameIsValid) {
         var paperInputElem = Polymer.dom(this.$.taskNameDialogBox).querySelector("#pi");
          if (paperInputElem.value === "") {
            alert("Task name cannot be empty");
          } else {
            taskNameIsValid = true;
          }
        },
        
         // on subsequent runs, it should retrive data in database
        _retriveSavedTasks: function() {
            var savedTaskList = [];
            if (localStorage.length !== 0) {
              // retrieve tasks
              for (var key in localStorage) {
                  var savedTask = JSON.parse( localStorage.getItem(key) );
                  if (savedTask.listName === this.listName) {
                        savedTaskList.push({
                        listName: savedTask.listName,
                        name: savedTask.name,
                        status: savedTask.status
                     });
                  }
                  
              }
           }
           return savedTaskList;
        },

        deleteTask: function(event) {
           var taskToDelete = event.model.item;
           localStorage.removeItem(taskToDelete.name);
           this._updateListView();
             

         },

         _showAddTaskDialogBox: function() {
           // use light dom here
            var dialogBox = Polymer.dom(this.root).querySelector('#taskNameDialogBox');
            dialogBox.open();
         },

         // it should clear list

        _updateListView: function() {
               var list = this._retriveSavedTasks();
               if (list.length !== 0) {
                    this.splice('taskList', 0);
                    var self = this;
                    list.forEach(function(savedTask){
                      self.push('taskList',{
                          listName: savedTask.listName,
                          name: savedTask.name,
                          status: savedTask.status
                      });
                  });
               }
               
         }
    });
  </script>
</dom-module>
